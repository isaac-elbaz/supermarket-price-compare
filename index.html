<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermarket Price Comparison</title>
    <link rel="icon" href="https://fav.farm/ðŸ›’"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-overflow: ellipsis;
        }

        .container {
            margin-bottom: 80px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            cursor: pointer;
        }

        .header h1 {
            font-size: 1.75rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .content {
            padding: 25px;
        }

        /* Supermarket */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 0;
            font-weight: 600;
            border: none;
        }

        td {
            padding: 12px 3px;
            line-height: 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.875rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .price-per-unit-cell {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .price-per-unit {
            color: #667eea;
        }

        .gap-percent {
            color: #cccccc;
        }

        .best-price {
            background: #d4edda !important;
        }

        .best-price .price-per-unit {
            color: #155724;
            font-weight: bold;
        }

        .remove-btn-cell {
            padding: 0;
            color: #ddd;
            text-align: center;
            cursor: pointer;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            th {
                font-size: 0.75rem;
                padding: 10px 0;
            }

            td {
                padding: 10px 3px;
            }

            input {
                padding: 6px;
            }
        }

        /* QR code Scanner */
        #reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .scan-btn, .add-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        .scan-btn:hover:not(:disabled), .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .scan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-container {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-container.active {
            display: block;
        }

        .result-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            border: 2px solid #e0e0e0;
        }

        .result-text a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .result-text a:hover {
            text-decoration: underline;
        }

        .copy-btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #667eea;
            color: white;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 0.875rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<!-- Supermarket -->
<div class="container" style="max-width: 800px;">
    <div class="header" onclick="newTab()">
        <div style="font-size: 3.6rem;">ðŸ›’</div>
        <h1>Price Comparison</h1>
        <p>Find out which is the cheapest with ease</p>
    </div>

    <div class="content">
        <table>
            <thead>
            <tr>
                <th style="width: 2%;"></th>
                <th style="width: 12%;">Name</th>
                <th style="width: 23%;">Price</th>
                <th style="width: 23%;">Quantity</th>
                <th style="width: 40%;">Price per unit</th>
            </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="button-group">
            <button class="add-btn" onclick="addRow()">+ Add</button>
        </div>
    </div>
</div>

<!-- QR code Scanner -->
<div class="container" style="max-width: 500px;">
    <div class="header" onclick="refresh()">
        <svg width="64px" height="64px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M9.75 5.25H5.25V9.75H9.75V5.25ZM3.75 3.75V11.25H11.25V3.75H3.75ZM9.75 14.25H5.25V18.75H9.75V14.25ZM3.75 12.75V20.25H11.25V12.75H3.75ZM14.25 5.25H18.75V9.75H14.25V5.25ZM12.75 11.25V3.75H20.25V11.25H12.75ZM12.75 17.25V12.75H14.25V17.25H12.75ZM6.75 6.75V8.25H8.25V6.75H6.75ZM6.75 17.25V15.75H8.25V17.25H6.75ZM15.75 6.75V8.25H17.25V6.75H15.75ZM18.75 20.25V18H20.25V20.25H18.75ZM18.75 12.75V15H17.25V12.75H15.75V18.75H12.75V20.25H17.25V16.5H20.25V15V12.75H18.75Z"
                  fill="#080341"/>
        </svg>
        <h1>QR code Scanner</h1>
        <p>Scan any QR code or Barcode instantly</p>
    </div>

    <div class="content">
        <button class="scan-btn" id="scanBtn" onclick="startScan()">Start Scanning</button>

        <div id="reader"></div>

        <div class="result-container" id="resultContainer">
            <div class="result-label">Scanned Code:</div>
            <div class="result-text" id="resultText"></div>
            <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()">ðŸ“‹ Copy to Clipboard</button>
        </div>

        <div class="status" id="status"></div>
    </div>
</div>

<script>
    function refresh() {
        window.location.reload();
    }

    function newTab() {
        const currentUrl = window.location.href; // Get the current URL
        window.open(currentUrl, "_blank"); // Open the current URL in a new tab
    }

    // Supermarket

    let products = [];

    function addRow() {
        const letter = String.fromCharCode("a".charCodeAt(0) + products.length);
        const product = {
            id: Date.now() + getRandomIntInclusive(1, 1000),
            name: letter,
            price: "",
            quantity: "",
        };
        products.push(product);

        const tbody = document.getElementById("tableBody");
        const tr = document.createElement("tr");
        tr.id = `row-${product.id}`;
        tr.innerHTML = `
            <td class="remove-btn-cell" onclick="removeRow(${product.id})">
                âœ—
            </td>
            <td>
                <input type="text" value="${product.name}"
                       onchange="updateProduct(${product.id}, 'name', this.value)"
                       placeholder="Product name"
                       tabindex="-1">
            </td>
            <td>
                <input type="number" value="${product.price}"
                       oninput="updateProduct(${product.id}, 'price', this.value)"
                       placeholder="0.00" min="0">
            </td>
            <td>
                <input type="number" value="${product.quantity}"
                       oninput="updateProduct(${product.id}, 'quantity', this.value)"
                       placeholder="0" min="0">
            </td>
            <td class="price-per-unit-cell">
                <span class="price-per-unit"></span>
                <span class="gap-percent"></span>
            </td>
        `;
        tbody.appendChild(tr);
        updateAllPriceHighlights();
    }

    function getRandomIntInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function removeRow(id) {
        products = products.filter(p => p.id !== id);
        document.getElementById(`row-${id}`).remove();
        updateAllPriceHighlights();
    }

    function updateProduct(id, field, value) {
        const product = products.find(p => p.id === id);
        if (product) {
            product[field] = value;
            updateAllPriceHighlights();
        }
    }

    function toInt(value) {
        if (!value) {
            return 0;
        }
        return Math.round(parseFloat(value) * 100);
    }

    function calcPricePerUnit(price, quantity) {
        if (!price || !quantity) {
            return 0;
        }
        return Math.round((price / quantity) * 100);
    }

    function updateAllPriceHighlights() {
        // Find lowest price per unit for highlighting (only valid products)
        let lowestPricePerUnit = Math.round(Number.MAX_VALUE);
        let count = 0;

        products.forEach(product => {
            const price = toInt(product.price);
            const quantity = toInt(product.quantity);
            // Only consider products with valid price AND quantity
            if (price > 0 && quantity > 0) {
                lowestPricePerUnit = Math.min(lowestPricePerUnit, calcPricePerUnit(price, quantity));
                count++;
            }
        });
        const moreThanOne = count > 1;

        // Update each row
        products.forEach(product => {
            const row = document.getElementById(`row-${product.id}`);
            if (!row) {
                return;
            }

            const price = toInt(product.price);
            const quantity = toInt(product.quantity);
            const pricePerUnit = calcPricePerUnit(price, quantity);
            const lowest = pricePerUnit && moreThanOne && pricePerUnit === lowestPricePerUnit;

            // Update price per unit text
            const pricePerUnitSpan = row.querySelector(".price-per-unit");
            const gapPercentSpan = row.querySelector(".gap-percent");

            pricePerUnitSpan.textContent = pricePerUnit ? (pricePerUnit / 100).toFixed(2) : "";

            if (pricePerUnit && moreThanOne && !lowest) {
                const gapPercent = Math.round(((pricePerUnit - lowestPricePerUnit) / lowestPricePerUnit) * 100);
                gapPercentSpan.textContent = ` (+${gapPercent}%)`;
            }
            else {
                gapPercentSpan.textContent = "";
            }

            // Update highlighting
            if (moreThanOne && lowest) {
                row.classList.add("best-price");
            }
            else {
                row.classList.remove("best-price");
            }
        });
    }

    // Initialize with 3 empty rows
    addRow();
    addRow();
    addRow();

    // QR code Scanner

    let html5QrCode;
    let isScanning = false;
    let scannedData = "";

    function isValidUrl(string) {
        try {
            const url = new URL(string);
            return url.protocol === "http:" || url.protocol === "https:";
        }
        catch (_) {
            return false;
        }
    }

    function vibrate() {
        if ("vibrate" in navigator) {
            navigator.vibrate(200);
        }
    }

    async function startScan() {
        const scanBtn = document.getElementById("scanBtn");
        const readerDiv = document.getElementById("reader");
        const resultContainer = document.getElementById("resultContainer");
        const status = document.getElementById("status");

        scanBtn.disabled = true;
        scanBtn.textContent = "Scanning...";
        readerDiv.style.display = "block";
        resultContainer.classList.remove("active");
        status.textContent = "Point your camera at a QR code or barcode";

        html5QrCode = new Html5Qrcode("reader");

        const config = {
            fps: 10,
            qrbox: {width: 250, height: 250},
        };

        try {
            await html5QrCode.start(
                {facingMode: "environment"},
                config,
                onScanSuccess,
                onScanError,
            );
            isScanning = true;
            status.scrollIntoView({behavior: "smooth"});
        }
        catch (err) {
            console.error("Unable to start scanning", err);
            status.textContent = "Error: Unable to access camera";
            scanBtn.disabled = false;
            scanBtn.textContent = "Start Scanning";
            readerDiv.style.display = "none";
        }
    }

    async function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) {
            return;
        }

        isScanning = false;
        scannedData = decodedText;

        // Stop scanning
        await html5QrCode.stop();

        // Vibrate
        vibrate();

        // Update UI
        const scanBtn = document.getElementById("scanBtn");
        const resultContainer = document.getElementById("resultContainer");
        const resultText = document.getElementById("resultText");
        const status = document.getElementById("status");

        scanBtn.disabled = false;
        scanBtn.textContent = "Start Scanning";

        // Display result
        if (isValidUrl(decodedText)) {
            resultText.innerHTML = `<a href="${decodedText}" target="_blank">${decodedText}</a>`;
        }
        else {
            resultText.textContent = decodedText;
        }

        resultContainer.classList.add("active");
        status.textContent = "Code scanned successfully!";

        // Reset copy button
        const copyBtn = document.getElementById("copyBtn");
        copyBtn.textContent = "ðŸ“‹ Copy to Clipboard";
        copyBtn.classList.remove("copied");
    }

    function onScanError(errorMessage) {
        // Ignore scan errors (they happen continuously while scanning)
    }

    async function copyToClipboard() {
        const copyBtn = document.getElementById("copyBtn");
        try {
            await navigator.clipboard.writeText(scannedData);
            copyBtn.textContent = "âœ“ Copied!";
            copyBtn.classList.add("copied");

            setTimeout(() => {
                copyBtn.textContent = "ðŸ“‹ Copy to Clipboard";
                copyBtn.classList.remove("copied");
            }, 2000);
        }
        catch (err) {
            console.error("Failed to copy:", err);
            copyBtn.textContent = "âœ— Failed to copy";
        }
    }
</script>
</body>
</html>